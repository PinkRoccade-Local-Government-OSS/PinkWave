"""
Performs payloads to test for XSS vulnerabilities

* Logger.php must be up and configured in config/localhost.json
"""
__author__ = "Maarten Schermer"

import sys,os,time
from base64 import b64encode
from os.path import abspath,dirname
import hashlib

# Importing PinkWave extensions
sys.path.append(dirname(dirname(dirname(abspath(__file__)))))
from extensions.Util import Util,report,payloads
import extensions.Request as Request

def labels():
    return ['A3 - Cross-site scripting (XSS)']

def options():
    return ['target','requestNames','request']

def start(pentest):
    for payload in payloads("xss",__file__):
            token = Util.getRandomHex(24)
            payload = payload.replace("{{logger}}",Util.getLogger())
            payload = payload.replace("{{url}}",pentest.target)
            payload = payload.replace("{{token}}",token)
            Request.do(pentest,payload)
            time.sleep(2)
            verify(pentest,token,payload)

def verify(pentest,token,payload):
    hash = hashlib.sha256("%s%s" % (Util.getSecret(),token)).hexdigest()
    if hash in pentest.browser.text():
        report("XSS detected via logging postback (%s)" % payload)
